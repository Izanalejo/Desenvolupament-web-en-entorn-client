<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <title>Exercici 6 - Proc√©s de Compra</title>
</head>
<body>
    <h1>Exercici 6 - Proc√©s de compra</h1>
    
    <h2>Carret:</h2>
    <ul id="carret"></ul>
    
    <button onclick="iniciarCompra()">Processar Compra</button>
    
    <h2>Log:</h2>
    <div id="log"></div>

    <script>
        // Carret amb productes
        const carret = [
            { nom: "Port√†til", preu: 899.99 },
            { nom: "Ratol√≠", preu: 25.50 },
            { nom: "Teclat", preu: 65.00 }
        ];

        // Mostrar carret
        function mostrarCarret() {
            const carretElement = document.getElementById('carret');
            carretElement.innerHTML = '';
            carret.forEach(producte => {
                const li = document.createElement('li');
                li.textContent = `${producte.nom} - ${producte.preu}‚Ç¨`;
                carretElement.appendChild(li);
            });
        }

        // Afegir al log
        function log(missatge) {
            const logElement = document.getElementById('log');
            const p = document.createElement('p');
            p.textContent = missatge;
            logElement.appendChild(p);
        }

        // 1. Validar carret
        function validarCarret(productes) {
            return new Promise((resolve, reject) => {
                setTimeout(() => {
                    log("Validant carret...");
                    
                    if (productes.length >= 3) {
                        log(`Carret v√†lid amb ${productes.length} productes`);
                        resolve({
                            productes: productes
                        });
                    } else {
                        reject(`El carret necessita m√≠nim 3 productes. Tens ${productes.length}`);
                    }
                }, 1000);
            });
        }

        // 2. Calcular preu final
        function calcularPreuFinal(dades) {
            return new Promise((resolve, reject) => {
                setTimeout(() => {
                    log("Calculant preu final...");
                    
                    const preuTotal = dades.productes.reduce((total, producte) => {
                        return total + producte.preu;
                    }, 0);
                    
                    if (preuTotal > 0) {
                        log(`Preu calculat: ${preuTotal.toFixed(2)}‚Ç¨`);
                        resolve({
                            ...dades,
                            preuTotal: preuTotal.toFixed(2)
                        });
                    } else {
                        reject("No s'ha pogut calcular el preu");
                    }
                }, 1500);
            });
        }

        // 3. Confirmar pagament
        function confirmarPagament(dades) {
            return new Promise((resolve, reject) => {
                setTimeout(() => {
                    log("Processant pagament...");
                    
                    const pagamentExitos = true;
                    
                    if (pagamentExitos) {
                        const numComanda = Math.floor(Math.random() * 10000);
                        log(` Pagament confirmat de ${dades.preuTotal}‚Ç¨`);
                        resolve({
                            ...dades,
                            numComanda: numComanda
                        });
                    } else {
                        reject("El pagament ha sigut rebutjat");
                    }
                }, 2000);
            });
        }

        // Iniciar compra amb promises encadenades
        function iniciarCompra() {
            document.getElementById('log').innerHTML = '';
            log("Iniciant proc√©s de compra...");
            
            validarCarret(carret)
                .then(dades => {
                    return calcularPreuFinal(dades);
                })
                .then(dades => {
                    return confirmarPagament(dades);
                })
                .then(dades => {
                    log(`üéâ Comanda #${dades.numComanda} completada amb √®xit!`);
                    log(`Total productes: ${dades.productes.length}`);
                    log(`Import total: ${dades.preuTotal}‚Ç¨`);
                })
                .catch(error => {
                    log(`‚õî Error: ${error}`);
                })
                .finally(() => {
                    log("Proc√©s finalitzat");
                });
        }

        // Inicialitzar
        mostrarCarret();
    </script>
</body>
</html>